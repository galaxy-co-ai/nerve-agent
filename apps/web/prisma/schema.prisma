// NERVE AGENT Database Schema
// Phase 1: Core Loop (Projects, Sprints, Tasks, Time Tracking)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// User (Extended from Clerk)
// ============================================================================

model User {
  id                String   @id // Clerk user ID
  email             String   @unique
  name              String?
  avatarUrl         String?

  // Preferences
  defaultView       String   @default("daily") // daily, projects
  theme             String   @default("dark")  // dark, light, system
  weekStartsOn      Int      @default(1)       // 0=Sun, 1=Mon

  // Time tracking preferences
  workingHoursStart String   @default("09:00")
  workingHoursEnd   String   @default("17:00")

  // Relationships
  projects          Project[]
  timeEntries       TimeEntry[]
  libraryItems      LibraryItem[]
  libraryTags       LibraryTag[]
  notes             Note[]
  faqs              Faq[]

  // Agent relationships
  agentPreferences    AgentPreferences?
  agentSuggestions    AgentSuggestion[]
  agentConversations  AgentConversation[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================================================
// Project
// ============================================================================

model Project {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name              String
  slug              String        @unique
  clientName        String
  clientEmail       String?
  description       String?

  // Status
  status            ProjectStatus @default(PLANNING)
  phase             ProjectPhase  @default(PLAN)
  health            Int           @default(100) // 0-100

  // Dates
  startDate         DateTime?
  targetEndDate     DateTime?
  actualEndDate     DateTime?

  // Financial
  contractValue     Decimal?
  hourlyRate        Decimal?
  paymentStructure  String?  // "half-half", "weekly", "milestone"

  // Client portal
  portalEnabled     Boolean  @default(true)
  portalToken       String?  @unique
  portalLastAccess  DateTime?

  // Relationships
  sprints           Sprint[]
  blockers          Blocker[]
  timeEntries       TimeEntry[]
  libraryItems      LibraryItem[]
  notes             Note[]
  portalFeedback    PortalFeedback[]
  calls             Call[]
  portalMagicLinks  PortalMagicLink[]
  followUps         FollowUp[]

  // Framework relationships
  frameworkDocs     ProjectFrameworkDoc[]
  checkpoints       ProjectCheckpoint[]
  workspaceNotes    ProjectWorkspaceNote[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectPhase {
  PLAN
  SPRINT
  SHIP
  SUPPORT
}

// ============================================================================
// Sprint
// ============================================================================

model Sprint {
  id                String       @id @default(cuid())
  projectId         String
  project           Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Basic info
  number            Int          // Sprint 1, 2, 3...
  name              String       // "Foundation", "Core Dashboard", etc.
  description       String?

  // Status
  status            SprintStatus @default(NOT_STARTED)

  // Time estimates
  estimatedHours    Decimal
  adjustedHours     Decimal?     // AI-adjusted estimate
  actualHours       Decimal      @default(0)

  // Dates
  plannedStartDate  DateTime?
  plannedEndDate    DateTime?
  actualStartDate   DateTime?
  actualEndDate     DateTime?

  // Relationships
  tasks             Task[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([projectId, number])
  @@index([projectId])
  @@index([status])
}

enum SprintStatus {
  NOT_STARTED
  IN_PROGRESS
  BLOCKED
  COMPLETED
}

// ============================================================================
// Task
// ============================================================================

model Task {
  id                String     @id @default(cuid())
  sprintId          String
  sprint            Sprint     @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  // Basic info
  title             String
  description       String?
  order             Int        // Order within sprint

  // Status
  status            TaskStatus @default(TODO)

  // Categorization
  category          String?    // "integration", "ui-component", "api", etc.
  tags              Json       @default("[]")

  // Time estimates
  estimatedHours    Decimal
  adjustedHours     Decimal?   // AI-adjusted
  actualHours       Decimal    @default(0)

  // Blocker reference
  blockerId         String?
  blocker           Blocker?   @relation(fields: [blockerId], references: [id])

  // Completion
  completedAt       DateTime?

  // Relationships
  timeEntries       TimeEntry[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([sprintId])
  @@index([status])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  COMPLETED
}

// ============================================================================
// Time Entry
// ============================================================================

model TimeEntry {
  id                String     @id @default(cuid())
  userId            String
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId         String
  project           Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskId            String?
  task              Task?      @relation(fields: [taskId], references: [id])

  // Time
  startTime         DateTime
  endTime           DateTime?
  durationMinutes   Int

  // Source
  source            TimeSource @default(AUTO)

  // Auto-tracking metadata
  appName           String?    // "VS Code", "Figma", etc.
  windowTitle       String?

  // Manual entry
  description       String?

  // Billing
  billable          Boolean    @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([taskId])
  @@index([startTime])
}

enum TimeSource {
  AUTO      // From desktop app
  MANUAL    // Manual entry
  ADJUSTED  // Adjusted during daily review
}

// ============================================================================
// Blocker
// ============================================================================

model Blocker {
  id                String        @id @default(cuid())
  projectId         String
  project           Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Content
  title             String
  description       String?

  // Type
  type              BlockerType   @default(HARD)

  // Who's responsible
  waitingOn         String        // "client", "self", "third-party"

  // Status
  status            BlockerStatus @default(ACTIVE)

  // Aging
  resolvedAt        DateTime?

  // Auto follow-up
  lastFollowUpAt    DateTime?
  followUpCount     Int           @default(0)

  // Relationships
  tasks             Task[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([projectId])
  @@index([status])
}

enum BlockerType {
  HARD   // Needs external input
  SOFT   // Can be worked around
}

enum BlockerStatus {
  ACTIVE
  RESOLVED
}

// ============================================================================
// Library - Reusable Code Library
// ============================================================================

model LibraryItem {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  title       String
  description String?
  code        String          @db.Text
  language    String          // "typescript", "sql", "css", etc.

  // Categorization
  type        LibraryItemType
  tags        LibraryTag[]

  // Project association (optional)
  projectId   String?
  project     Project?        @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // Usage tracking
  usageCount  Int             @default(0)
  lastUsedAt  DateTime?

  // Metadata
  isFavorite  Boolean         @default(false)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([userId])
  @@index([type])
  @@index([projectId])
}

enum LibraryItemType {
  BLOCK    // Large implementations (auth flows, dashboards)
  PATTERN  // Smaller snippets (hooks, utilities)
  QUERY    // Database patterns
}

model LibraryTag {
  id          String        @id @default(cuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  color       String        @default("#6366f1") // Indigo default

  items       LibraryItem[]

  createdAt   DateTime      @default(now())

  @@unique([userId, name])
  @@index([userId])
}

// ============================================================================
// Portal Feedback - Client feedback on project portal
// ============================================================================

model PortalFeedback {
  id          String              @id @default(cuid())
  projectId   String
  project     Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Author info (captured at submission time)
  authorName  String
  authorEmail String?

  // Content
  content     String              @db.Text
  pageUrl     String?
  screenshot  String?             // URL to screenshot if provided

  // Categorization
  type        FeedbackType        @default(SUGGESTION)

  // Status
  status      FeedbackStatus      @default(NEW)
  response    String?             @db.Text
  respondedAt DateTime?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([projectId])
  @@index([status])
}

enum FeedbackType {
  BUG
  SUGGESTION
  QUESTION
  APPROVAL
}

enum FeedbackStatus {
  NEW
  ACKNOWLEDGED
  RESOLVED
}

// ============================================================================
// Portal Magic Links - Client Authentication
// ============================================================================

model PortalMagicLink {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  email       String
  token       String    @unique
  expiresAt   DateTime
  usedAt      DateTime?

  createdAt   DateTime  @default(now())

  @@index([projectId])
  @@index([email])
  @@index([token])
}

// ============================================================================
// Call Intelligence - Call Transcripts and Briefs
// ============================================================================

model Call {
  id            String        @id @default(cuid())
  userId        String
  projectId     String
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Basic info
  title         String
  callDate      DateTime
  participants  String?       // Comma-separated names

  // Content
  transcript    String        @db.Text

  // AI-processed fields
  summary       String?       @db.Text
  actionItems   Json          @default("[]")  // Array of {text, assignedTo, dueDate?}
  decisions     Json          @default("[]")  // Array of {text, decidedBy}
  sentiment     CallSentiment?

  // Sharing
  briefShared   Boolean       @default(false)
  briefToken    String?       @unique         // For shareable link

  // Relationships
  followUps     FollowUp[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([callDate])
}

enum CallSentiment {
  POSITIVE
  NEUTRAL
  CONCERNED
}

// ============================================================================
// Notes - Project Knowledge Capture
// ============================================================================

model Note {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  title       String
  content     String    @db.Text
  slug        String

  // Project association (optional)
  projectId   String?
  project     Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  // Organization
  isPinned    Boolean   @default(false)
  tags        Json      @default("[]")  // Array of tag strings

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, slug])
  @@index([userId])
  @@index([projectId])
}

// ============================================================================
// Follow-Up - Action items from calls requiring follow-up
// ============================================================================

model FollowUp {
  id            String         @id @default(cuid())
  userId        String
  callId        String?
  call          Call?          @relation(fields: [callId], references: [id], onDelete: SetNull)
  projectId     String
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Content
  title         String
  description   String?
  sourceType    FollowUpSource @default(CALL)
  sourceQuote   String?        // Quote from the call that generated this

  // Scheduling
  dueDate       DateTime?
  status        FollowUpStatus @default(SUGGESTED)
  completedAt   DateTime?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
}

enum FollowUpSource {
  CALL
  MANUAL
  AI_SUGGESTED
}

enum FollowUpStatus {
  SUGGESTED
  SCHEDULED
  PENDING
  COMPLETED
  DISMISSED
}

// ============================================================================
// FAQ - AI Question/Answer Log
// ============================================================================

model Faq {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Question and answer
  question    String    @db.Text
  answer      String    @db.Text

  // Context
  context     String?   // What page/feature the question was asked from

  // Metadata
  isHelpful   Boolean?  // User feedback
  usageCount  Int       @default(1)  // How many times similar question asked

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([createdAt])
}

// ============================================================================
// Project Framework - Document Templates (01-12)
// ============================================================================

model ProjectFrameworkDoc {
  id          String            @id @default(cuid())
  projectId   String
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Document identification
  docNumber   Int               // 1-12
  docType     FrameworkDocType

  // Content
  content     String            @db.Text

  // Status
  status      FrameworkDocStatus @default(DRAFT)
  lockedAt    DateTime?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([projectId, docNumber])
  @@index([projectId])
  @@index([status])
}

enum FrameworkDocType {
  IDEA_AUDIT
  PROJECT_BRIEF
  PRD
  TAD
  AI_COLLAB_PROTOCOL
  MTS
  TEST_PLAN
  AUDIT_CHECKLIST
  DECISION_LOG
  PROJECT_PULSE
  SHIP_CHECKLIST
  RETROSPECTIVE
}

enum FrameworkDocStatus {
  DRAFT
  LOCKED
}

// ============================================================================
// Project Checkpoint - MTS Phases/Checkpoints with Time Tracking
// ============================================================================

model ProjectCheckpoint {
  id            String            @id @default(cuid())
  projectId     String
  project       Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Identification
  checkpointId  String            // "CP-1.1", "CP-2.3", etc.
  name          String
  phase         Int               // 1-6

  // Status
  status        CheckpointStatus  @default(PENDING)

  // Time tracking
  estimatedMins Int?
  actualMins    Int               @default(0)
  startedAt     DateTime?
  completedAt   DateTime?

  // Relationships
  sessions      CheckpointSession[]
  objectives    ProjectObjective[]

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([projectId, checkpointId])
  @@index([projectId])
  @@index([status])
  @@index([phase])
}

enum CheckpointStatus {
  PENDING
  IN_PROGRESS
  COMPLETE
}

// ============================================================================
// Checkpoint Session - Individual Work Sessions
// ============================================================================

model CheckpointSession {
  id            String            @id @default(cuid())
  checkpointId  String
  checkpoint    ProjectCheckpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)

  // Session timing
  startedAt     DateTime          @default(now())
  endedAt       DateTime?
  durationMins  Int?

  // Optional notes
  notes         String?           @db.Text

  createdAt     DateTime          @default(now())

  @@index([checkpointId])
  @@index([startedAt])
}

// ============================================================================
// Project Objective - Objectives within Checkpoints
// ============================================================================

model ProjectObjective {
  id            String            @id @default(cuid())
  checkpointId  String
  checkpoint    ProjectCheckpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)

  // Identification
  objectiveId   String            // "1.1.1", "2.3.2", etc.
  name          String
  acceptance    String            @db.Text

  // Status
  status        ObjectiveStatus   @default(PENDING)

  // Relationships
  steps         ProjectStep[]

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([checkpointId, objectiveId])
  @@index([checkpointId])
  @@index([status])
}

enum ObjectiveStatus {
  PENDING
  IN_PROGRESS
  COMPLETE
}

// ============================================================================
// Project Step - Steps within Objectives
// ============================================================================

model ProjectStep {
  id            String            @id @default(cuid())
  objectiveId   String
  objective     ProjectObjective  @relation(fields: [objectiveId], references: [id], onDelete: Cascade)

  // Identification
  stepId        String            // "1.1.1.1", "2.3.2.4", etc.
  action        String            @db.Text
  acceptance    String            @db.Text

  // Status
  status        StepStatus        @default(PENDING)
  completedAt   DateTime?

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([objectiveId, stepId])
  @@index([objectiveId])
  @@index([status])
}

enum StepStatus {
  PENDING
  COMPLETE
}

// ============================================================================
// Project Workspace Note - Scratchpad for User + Claude
// ============================================================================

model ProjectWorkspaceNote {
  id            String    @id @default(cuid())
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Optional checkpoint association
  checkpointId  String?

  // Content
  author        String    // "user" or "claude"
  content       String    @db.Text

  createdAt     DateTime  @default(now())

  @@index([projectId])
  @@index([checkpointId])
  @@index([createdAt])
}

// ============================================================================
// AI Agent System
// ============================================================================

// Agent Preferences - User settings for agent behavior
model AgentPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Proactive behavior
  proactiveEnabled    Boolean  @default(true)
  autoDraftFollowups  Boolean  @default(true)
  morningBriefEnabled Boolean  @default(false)
  morningBriefTime    String   @default("09:00")

  // Quiet hours
  quietHoursEnabled   Boolean  @default(true)
  quietHoursStart     String   @default("22:00")
  quietHoursEnd       String   @default("08:00")

  // Communication style (learned + explicit)
  preferredStyle      String   @default("concise") // concise, detailed
  timezone            String   @default("America/New_York")

  // Learned patterns (JSON)
  learnedPatterns     Json     @default("[]")

  // Auto-approve settings
  autoApproveTypes    Json     @default("[]") // ["draft-note", "analyze-blocker"]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// Agent Suggestion - Proactive suggestions waiting for user action
model AgentSuggestion {
  id              String              @id @default(cuid())
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What triggered this
  triggerType     String              // "blocker_stale", "sprint_complete", "task_stuck", etc.
  triggerEntityId String?             // ID of the blocker, sprint, task, etc.

  // The suggestion
  type            String              // "follow-up", "summary", "analysis", "reminder"
  title           String
  description     String              @db.Text
  projectId       String?
  projectName     String?

  // What the agent proposes to do
  proposedAction  String              // "draft_email", "generate_summary", etc.
  actionPayload   Json                @default("{}") // Data needed to execute

  // Status
  status          AgentSuggestionStatus @default(PENDING)
  respondedAt     DateTime?
  dismissReason   String?

  // Priority
  urgency         String              @default("normal") // "low", "normal", "urgent"

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum AgentSuggestionStatus {
  PENDING
  APPROVED
  DISMISSED
  AUTO_EXECUTED
  EXPIRED
}

// Agent Conversation - Chat sessions with the agent
model AgentConversation {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional context
  projectId   String?
  title       String?

  // Messages
  messages    AgentMessage[]

  // Metadata
  messageCount Int            @default(0)
  lastMessageAt DateTime?

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([userId])
  @@index([lastMessageAt])
}

// Agent Message - Individual messages in a conversation
model AgentMessage {
  id              String            @id @default(cuid())
  conversationId  String
  conversation    AgentConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Message content
  role            String            // "user" or "agent"
  content         String            @db.Text

  // Tool usage (for agent messages)
  toolCalls       Json?             // [{name, input, result}]

  // Metadata
  tokenCount      Int?

  createdAt       DateTime          @default(now())

  @@index([conversationId])
  @@index([createdAt])
}
